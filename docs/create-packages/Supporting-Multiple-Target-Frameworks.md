---
title: Многоплатформенное нацеливание пакетов NuGet
description: Описание различных способов нацеливания на несколько версий .NET Framework из одного пакета NuGet.
author: kraigb
ms.author: kraigb
manager: douge
ms.date: 09/27/2017
ms.topic: conceptual
ms.openlocfilehash: d1a64c61954381b7ab3a7ecc8aa5a812cfa14e8b
ms.sourcegitcommit: 3eab9c4dd41ea7ccd2c28bb5ab16f6fbbec13708
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/26/2018
---
# <a name="supporting-multiple-net-framework-versions"></a>Поддержка нескольких версий платформы .NET Framework

*Сведения о межплатформенном нацеливании для проектов .NET Core, использующих NuGet 4.0 или более поздней версии, см. в разделе [Создание и восстановление пакетов NuGet в качестве целей MSBuild](../reference/msbuild-targets.md).*

Многие библиотеки предназначаются для определенной версии платформы .NET Framework. Например, у вас может быть одна версия библиотеки для универсальной платформы Windows и другая версия, использующая возможности .NET Framework 4.6.

Для реализации такого сценария NuGet поддерживает объединение нескольких версий одной и той же библиотеки в одном пакете при использовании метода на основе рабочего каталога, соответствующего соглашениям, описанного в разделе [Создание пакета](../create-packages/creating-a-package.md#from-a-convention-based-working-directory).

## <a name="framework-version-folder-structure"></a>Структура папок, соответствующих версиям платформы

При создании пакета, который содержит только одну версию библиотеки или предназначается для нескольких платформ, вы всегда создаете в папке `lib` вложенные папки с именами платформ (с учетом регистра) согласно следующим соглашениям:

    lib\{framework name}[{version}]

Полный список поддерживаемых имен см. в [справочнике по целевым платформам](../reference/target-frameworks.md#supported-frameworks).

Никогда не следует включать версию библиотеки, не относящуюся к конкретной платформе, помещая ее непосредственно в корневую папку `lib`. (Такая возможность поддерживалась только в `packages.config`.) Если поступить так, пакет будет совместим с любой целевой платформой и его можно будет установить где угодно, что, скорее всего, приведет к непредвиденным ошибкам во время выполнения. Возможность добавления сборок в корневую папку (например, `lib\abc.dll`) или ее вложенные папки (например, `lib\abc\abc.dll`) является нерекомендуемой и игнорируется при использовании формата PackagesReference.

Например, следующая структура папок поддерживает четыре версии сборки для конкретных платформ:

    \lib
        \net46
            \MyAssembly.dll
        \net461
            \MyAssembly.dll
        \uap
            \MyAssembly.dll
        \netcore
            \MyAssembly.dll

Чтобы легко включить все эти файлы при сборке пакета, используйте рекурсивный подстановочный знак `**` в разделе `<files>` файла `.nuspec`:

```xml
<files>
    <file src="lib\**" target="lib/{framework name}[{version}]" />
</files>
```

### <a name="architecture-specific-folders"></a>Папки для конкретных архитектур

Если имеются сборки для конкретных архитектур, то есть отдельные сборки для архитектур ARM, x86 и x64, их необходимо поместить в папку с именем `runtimes` во вложенные папки `{platform}-{architecture}\lib\{framework}` или `{platform}-{architecture}\native`. Например, следующая структура папок содержит как библиотеки DLL в машинном коде, так и управляемые библиотеки DLL для Windows 10 и платформы `uap10.0`:

    \runtimes
        \win10-arm
            \native
            \lib\uap10.0
        \win10-x86
            \native
            \lib\uap10.0
        \win10-x64
            \native
            \lib\uap10.0

Пример указания ссылок на эти файлы в манифесте `.nuspec` см. в разделе [Создание пакетов универсальной платформы Windows](../guides/create-uwp-packages.md).

## <a name="matching-assembly-versions-and-the-target-framework-in-a-project"></a>Сопоставление версий сборки и целевых платформ в проекте

Когда диспетчер NuGet устанавливает пакет с несколькими версиями сборки, он пытается сопоставить имя платформы, для которой предназначена сборка, с целевой платформой проекта.

Если соответствия не найдено, NuGet копирует сборку с самой старшей версией, которая не старше версии целевой платформы проекта, при условии, что такая версия сборки доступна. Если совместимая сборка не найдена, NuGet возвращает соответствующее сообщение об ошибке.

Например, рассмотрим следующую структуру папок в пакете:

    \lib
        \net45
            \MyAssembly.dll
        \net461
            \MyAssembly.dll

При установке этого пакета в проекте, предназначенном для .NET Framework 4.6, NuGet устанавливает сборку из папки `net45`, так как это самая старшая доступная версия не выше 4.6.

Если же проект предназначен для .NET Framework 4.6.1, NuGet устанавливает сборку в папке `net461`.

Если проект предназначен для .NET Framework 4.0 или более ранней версии, NuGet выдает сообщение об ошибке отсутствия совместимой сборки.

## <a name="grouping-assemblies-by-framework-version"></a>Группирование сборок по версии платформы

NuGet копирует сборки только из одной папки библиотеки в проекте. Предположим, есть пакет со следующей структурой папок:

    \lib
        \net40
            \MyAssembly.dll (v1.0)
            \MyAssembly.Core.dll (v1.0)
        \net45
            \MyAssembly.dll (v2.0)

Когда этот пакет устанавливается в проекте, предназначенном для .NET Framework 4.5, устанавливается только сборка `MyAssembly.dll` (версия 2.0). Сборка `MyAssembly.Core.dll` (версия 1.0) не устанавливается, так как ее нет в папке `net45`. Такое поведение NuGet обусловлено тем, что сборка `MyAssembly.Core.dll` могла быть объединена с версией 2.0 сборки `MyAssembly.dll`.

Чтобы установить сборку `MyAssembly.Core.dll` для .NET Framework 4.5, поместите ее копию в папку `net45`.

## <a name="grouping-assemblies-by-framework-profile"></a>Группирование сборок по профилю платформы

NuGet также поддерживает нацеливание на определенный профиль платформы путем добавления дефиса и имени платформы в конце имени папки.

    lib\{framework name}-{profile}

Поддерживаются следующие профили:

- `client`: клиентский профиль;
- `full`: полный профиль;
- `wp`: Windows Phone;
- `cf`: Compact Framework.

## <a name="determining-which-nuget-target-to-use"></a>Определение требуемой цели NuGet

При упаковке библиотек, предназначенных для переносимой библиотеки классов, может быть нелегко определить цель NuGet, которую следует использовать в именах папок и файле `.nuspec`, особенно если нацеливание производится лишь на подмножество переносимой библиотеки классов. Следующие внешние ресурсы могут помочь в решении этой задачи:

- [Профили платформы в .NET](http://blog.stephencleary.com/2012/05/framework-profiles-in-net.html) (stephenclearly.com)
- [Профили переносимой библиотеки классов](http://embed.plnkr.co/03ck2dCtnJogBKHJ9EjY/preview) (plnkr.co): таблица, в которой перечисляются профили переносимой библиотеки классов и эквивалентные цели NuGet
- [Программа для работы с профилями переносимой библиотеки классов](https://github.com/StephenCleary/PortableLibraryProfiles) (github.com): программа командной строки, позволяющая определить профили переносимой библиотеки классов, доступные в системе

## <a name="content-files-and-powershell-scripts"></a>Файлы содержимого и скрипты PowerShell

> [!Warning]
> Изменяемые файлы содержимого и выполнение скриптов можно использовать только с форматом `packages.config`. Их не рекомендуется использовать с другими форматами и не следует применять для новых пакетов.

При использовании `packages.config` файлы содержимого и скрипты PowerShell можно группировать по целевой платформе в папках `content` и `tools`, используя те же соглашения в отношении папок. Пример:

    \content
        \net46
            \MyContent.txt
        \net461
            \MyContent461.txt
        \uap
            \MyUWPContent.html
        \netcore
    \tools
        init.ps1
        \net46
            install.ps1
            uninstall.ps1
        \uap
            install.ps1
            uninstall.ps1

Если папка платформы пуста, NuGet не добавляет ссылки на сборки или файлы содержимого и не выполняет скрипты PowerShell для этой платформы.

> [!Note]
> Так как скрипт `init.ps1` выполняется на уровне решения независимо от проекта, его необходимо поместить непосредственно в папку `tools`. Если он находится в папке платформы, то он игнорируется.
