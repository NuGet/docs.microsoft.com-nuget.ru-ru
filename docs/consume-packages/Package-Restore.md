---
title: Восстановление пакета NuGet
description: Описание того, как NuGet восстанавливает пакеты, от которых зависит проект, включая отключение восстановления и ограничения версий.
author: karann-msft
ms.author: karann
ms.date: 08/05/2019
ms.topic: conceptual
ms.openlocfilehash: c1f1957c58839ac763238938b476eb0882c56a59
ms.sourcegitcommit: c81561e93a7be467c1983d639158d4e3dc25b93a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2020
ms.locfileid: "78231216"
---
# <a name="restore-packages-using-package-restore"></a><span data-ttu-id="b9390-103">Восстановление пакетов с помощью функции восстановления пакетов</span><span class="sxs-lookup"><span data-stu-id="b9390-103">Restore packages using Package Restore</span></span>

<span data-ttu-id="b9390-104">Чтобы очистить среду разработки и уменьшить размер репозитория, **функция восстановления пакетов** NuGet устанавливает все зависимости проекта, указанные в файле проекта или файле `packages.config`.</span><span class="sxs-lookup"><span data-stu-id="b9390-104">To promote a cleaner development environment and to reduce repository size, NuGet **Package Restore** installs all of a project's dependencies listed in either the project file or `packages.config`.</span></span> <span data-ttu-id="b9390-105">В версиях .NET Core 2.0 и более поздних команды `dotnet build` и `dotnet run` выполняют автоматическое восстановление пакетов.</span><span class="sxs-lookup"><span data-stu-id="b9390-105">The .NET Core 2.0+ `dotnet build` and `dotnet run` commands do an automatic package restore.</span></span> <span data-ttu-id="b9390-106">Visual Studio может автоматически восстанавливать пакеты при сборке проекта. Кроме того, вы можете в любой момент самостоятельно восстановить пакеты с помощью Visual Studio, `nuget restore`, `dotnet restore`, а также xbuild в Mono.</span><span class="sxs-lookup"><span data-stu-id="b9390-106">Visual Studio can restore packages automatically when it builds a project, and you can restore packages at any time through Visual Studio, `nuget restore`, `dotnet restore`, and xbuild on Mono.</span></span>

<span data-ttu-id="b9390-107">Восстановление пакетов гарантирует доступность всех зависимостей проекта без сохранения этих пакетов в системе управления версиями.</span><span class="sxs-lookup"><span data-stu-id="b9390-107">Package Restore makes sure that all a project's dependencies are available, without having to store them in source control.</span></span> <span data-ttu-id="b9390-108">Дополнительные сведения о настройке исключения двоичных файлов пакетов в репозитории системы управления версиями см. в статье [Пакеты и система управления версиями](../consume-packages/packages-and-source-control.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-108">To configure your source control repository to exclude the package binaries, see [Packages and source control](../consume-packages/packages-and-source-control.md).</span></span> 

## <a name="package-restore-overview"></a><span data-ttu-id="b9390-109">Обзор восстановления пакетов</span><span class="sxs-lookup"><span data-stu-id="b9390-109">Package Restore overview</span></span>

<span data-ttu-id="b9390-110">Функция восстановления пакетов сначала устанавливает необходимые прямые зависимости проекта, а затем остальные зависимости этих пакетов во всей схеме зависимостей.</span><span class="sxs-lookup"><span data-stu-id="b9390-110">Package Restore first installs the direct dependencies of a project as needed, then installs any dependencies of those packages throughout the entire dependency graph.</span></span>

<span data-ttu-id="b9390-111">Если пакет не установлен, NuGet сначала попытается извлечь его из [кэша](../consume-packages/managing-the-global-packages-and-cache-folders.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-111">If a package isn't already installed, NuGet first attempts to retrieve it from the [cache](../consume-packages/managing-the-global-packages-and-cache-folders.md).</span></span> <span data-ttu-id="b9390-112">Если пакет отсутствует в кэше, NuGet пытается скачать его из всех источников, которые включены в списке в разделе **Средства** > **Параметры** > **Диспетчер пакетов NuGet** > **Источники пакетов** в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b9390-112">If the package isn't in the cache, NuGet tries to download the package from all enabled sources in the list at **Tools** > **Options** > **NuGet Package Manager** > **Package Sources** in Visual Studio.</span></span> <span data-ttu-id="b9390-113">Во время восстановления NuGet игнорирует порядок источников пакетов, используя пакет из любого источника, первым ответившего на запросы.</span><span class="sxs-lookup"><span data-stu-id="b9390-113">During restore, NuGet ignores the order of package sources, and uses the package from whichever source is first to respond to requests.</span></span> <span data-ttu-id="b9390-114">Дополнительные сведения о поведении NuGet см. в статье [Распространенные конфигурации NuGet](Configuring-NuGet-Behavior.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-114">For more information about how NuGet behaves, see [Common NuGet configurations](Configuring-NuGet-Behavior.md).</span></span> 

> [!Note]
> <span data-ttu-id="b9390-115">NuGet не сообщает о сбое восстановления пакета до проверки всех источников.</span><span class="sxs-lookup"><span data-stu-id="b9390-115">NuGet doesn't indicate a failure to restore a package until all the sources have been checked.</span></span> <span data-ttu-id="b9390-116">После проверки NuGet сообщает о сбое только для последнего источника в списке.</span><span class="sxs-lookup"><span data-stu-id="b9390-116">At that time, NuGet reports a failure for only the last source in the list.</span></span> <span data-ttu-id="b9390-117">Такая ошибка означает, что пакет отсутствовал и во *всех* других источниках, хотя отдельные ошибки для них не выдавались.</span><span class="sxs-lookup"><span data-stu-id="b9390-117">The error implies that the package wasn't present on *any* of the other sources, even though errors aren't shown for each of those sources individually.</span></span>

## <a name="restore-packages"></a><span data-ttu-id="b9390-118">Восстановление пакетов</span><span class="sxs-lookup"><span data-stu-id="b9390-118">Restore packages</span></span>

<span data-ttu-id="b9390-119">Функция восстановления пакетов пытается установить все зависимости пакетов в правильном состоянии с учетом ссылок на пакет в файле проекта ( *.csproj*) или файле *packages.config*.</span><span class="sxs-lookup"><span data-stu-id="b9390-119">Package Restore tries to install all package dependencies to the correct state matching the package references in your project file (*.csproj*) or your *packages.config* file.</span></span> <span data-ttu-id="b9390-120">(В Visual Studio ссылки отображаются в обозревателе решений в узле **Зависимости \ NuGet** или **Ссылки**.)</span><span class="sxs-lookup"><span data-stu-id="b9390-120">(In Visual Studio, the references appear in Solution Explorer under the **Dependencies \ NuGet** or the **References** node.)</span></span>

1. <span data-ttu-id="b9390-121">Если ссылки на пакет в файле проекта правильные, используйте привычное средство для восстановления пакетов.</span><span class="sxs-lookup"><span data-stu-id="b9390-121">If the package references in your project file are correct, use your preferred tool to restore packages.</span></span>

   - <span data-ttu-id="b9390-122">[Visual Studio](#restore-using-visual-studio) ([автоматическое восстановление](#restore-packages-automatically-using-visual-studio) или [восстановление вручную](#restore-packages-manually-using-visual-studio))</span><span class="sxs-lookup"><span data-stu-id="b9390-122">[Visual Studio](#restore-using-visual-studio) ([automatic restore](#restore-packages-automatically-using-visual-studio) or [manual restore](#restore-packages-manually-using-visual-studio))</span></span>
   - [<span data-ttu-id="b9390-123">dotnet CLI</span><span class="sxs-lookup"><span data-stu-id="b9390-123">dotnet CLI</span></span>](#restore-using-the-dotnet-cli)
   - [<span data-ttu-id="b9390-124">Интерфейс командной строки nuget.exe</span><span class="sxs-lookup"><span data-stu-id="b9390-124">nuget.exe CLI</span></span>](#restore-using-the-nugetexe-cli)
   - [<span data-ttu-id="b9390-125">MSBuild</span><span class="sxs-lookup"><span data-stu-id="b9390-125">MSBuild</span></span>](#restore-using-msbuild)
   - [<span data-ttu-id="b9390-126">Azure Pipelines</span><span class="sxs-lookup"><span data-stu-id="b9390-126">Azure Pipelines</span></span>](#restore-using-azure-pipelines)
   - [<span data-ttu-id="b9390-127">Azure DevOps Server</span><span class="sxs-lookup"><span data-stu-id="b9390-127">Azure DevOps Server</span></span>](#restore-using-azure-devops-server)

   <span data-ttu-id="b9390-128">Если пакет ссылается на файл проекта( *.csproj*) или если файл *packages.config* неправильный (не соответствует требуемому состоянию после восстановления пакета), необходимо установить или обновить пакеты.</span><span class="sxs-lookup"><span data-stu-id="b9390-128">If the package references in your project file (*.csproj*) or your *packages.config* file are incorrect (they do not match your desired state following Package Restore), then you need to either install or update packages instead.</span></span>

   <span data-ttu-id="b9390-129">Если для проектов используется PackageReference, после успешного восстановления пакет должен присутствовать в *global-packages*, а файл `obj/project.assets.json` будет создан повторно.</span><span class="sxs-lookup"><span data-stu-id="b9390-129">For projects using PackageReference, after a successful restore, the package should be present in the *global-packages* folder and the `obj/project.assets.json` file is recreated.</span></span> <span data-ttu-id="b9390-130">Если для проектов используется `packages.config`, пакет должен отображаться в папке `packages` проекта.</span><span class="sxs-lookup"><span data-stu-id="b9390-130">For projects using `packages.config`, the package should appear in the project's `packages` folder.</span></span> <span data-ttu-id="b9390-131">Теперь сборка проекта должна пройти без ошибок.</span><span class="sxs-lookup"><span data-stu-id="b9390-131">The project should now build successfully.</span></span> 

2. <span data-ttu-id="b9390-132">Если после запуска функции восстановления пакетов пакеты по-прежнему отсутствуют или появляются связанные с пакетами ошибки (например, значки ошибок в обозревателе решений в Visual Studio), следуйте инструкциям, описанным в разделе [Устранение ошибок при восстановлении пакетов](package-restore-troubleshooting.md) или попробуйте [переустановить и обновить пакеты](../consume-packages/reinstalling-and-updating-packages.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-132">After running Package Restore, if you still experience missing packages or package-related errors (such as error icons in Solution Explorer in Visual Studio), you may need to follow instructions described in [Troubleshooting Package Restore errors](package-restore-troubleshooting.md) or, alternatively, [reinstall and update packages](../consume-packages/reinstalling-and-updating-packages.md).</span></span>

   <span data-ttu-id="b9390-133">В Visual Studio консоль диспетчера пакетов позволяет переустанавливать пакеты несколькими способами.</span><span class="sxs-lookup"><span data-stu-id="b9390-133">In Visual Studio, the Package Manager Console provides several flexible options for reinstalling packages.</span></span> <span data-ttu-id="b9390-134">См. об [использовании Package-Update](reinstalling-and-updating-packages.md#using-update-package).</span><span class="sxs-lookup"><span data-stu-id="b9390-134">See [Using Package-Update](reinstalling-and-updating-packages.md#using-update-package).</span></span>

## <a name="restore-using-visual-studio"></a><span data-ttu-id="b9390-135">Восстановление с помощью Visual Studio</span><span class="sxs-lookup"><span data-stu-id="b9390-135">Restore using Visual Studio</span></span>

<span data-ttu-id="b9390-136">В Visual Studio в Windows выполните одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="b9390-136">In Visual Studio on Windows, either:</span></span>

- <span data-ttu-id="b9390-137">восстановите пакеты автоматически ИЛИ</span><span class="sxs-lookup"><span data-stu-id="b9390-137">Restore packages automatically, or</span></span>

- <span data-ttu-id="b9390-138">восстановите пакеты вручную.</span><span class="sxs-lookup"><span data-stu-id="b9390-138">Restore packages manually</span></span>

### <a name="restore-packages-automatically-using-visual-studio"></a><span data-ttu-id="b9390-139">Автоматическое восстановление пакетов с помощью Visual Studio</span><span class="sxs-lookup"><span data-stu-id="b9390-139">Restore packages automatically using Visual Studio</span></span>

<span data-ttu-id="b9390-140">Восстановление пакетов осуществляется автоматически при создании проекта на основе шаблона или во время сборки проекта. При этом учитываются значения параметров, представленных в разделе [Включение и отключение восстановления пакетов](#enable-and-disable-package-restore-in-visual-studio).</span><span class="sxs-lookup"><span data-stu-id="b9390-140">Package Restore happens automatically when you create a project from a template or build a project, subject to the options in [Enable and disable package restore](#enable-and-disable-package-restore-in-visual-studio).</span></span> <span data-ttu-id="b9390-141">В NuGet 4.0 и более поздних версий также доступно автоматическое восстановление при изменении проекта типа пакета SDK (как правило, проекта .NET Core или .NET Standard).</span><span class="sxs-lookup"><span data-stu-id="b9390-141">In NuGet 4.0+, restore also happens automatically when you make changes to a SDK-style project (typically a .NET Core or .NET Standard project).</span></span>

1. <span data-ttu-id="b9390-142">Включите автоматическое восстановление пакетов, выбрав **Средства** > **Параметры** > **Диспетчер пакетов NuGet** и щелкните **Автоматически проверять отсутствие пакетов при сборке в Visual Studio** в разделе **Восстановление пакетов**.</span><span class="sxs-lookup"><span data-stu-id="b9390-142">Enable automatic package restore by choosing **Tools** > **Options** > **NuGet Package Manager**, and then selecting **Automatically check for missing packages during build in Visual Studio** under **Package Restore**.</span></span>

   <span data-ttu-id="b9390-143">Для проектов не на основе пакета SDK сначала выберите **Разрешить NuGet скачивать отсутствующие пакеты**, чтобы включить автоматическое восстановление.</span><span class="sxs-lookup"><span data-stu-id="b9390-143">For non-SDK-style projects, you first need to select **Allow NuGet to download missing packages** to enable the automatic restore option.</span></span>

1. <span data-ttu-id="b9390-144">Выполните построение проекта.</span><span class="sxs-lookup"><span data-stu-id="b9390-144">Build the project.</span></span>

   <span data-ttu-id="b9390-145">Если какие-либо пакеты по-прежнему установлены некорректно, в **обозревателе решений** отображается значок ошибки.</span><span class="sxs-lookup"><span data-stu-id="b9390-145">If one or more individual packages still aren't installed properly, **Solution Explorer** shows an error icon.</span></span> <span data-ttu-id="b9390-146">Щелкните правой кнопкой мыши и выберите **Управление пакетами NuGet**, после чего удалите и переустановите затронутые пакеты с помощью **диспетчера пакетов**.</span><span class="sxs-lookup"><span data-stu-id="b9390-146">Right-click and select **Manage NuGet Packages**, and use **Package Manager** to uninstall and reinstall the affected packages.</span></span> <span data-ttu-id="b9390-147">Дополнительные сведения см. в статье [Переустановка и обновление пакетов](../consume-packages/reinstalling-and-updating-packages.md)</span><span class="sxs-lookup"><span data-stu-id="b9390-147">For more information, see [Reinstall and update packages](../consume-packages/reinstalling-and-updating-packages.md)</span></span>

   <span data-ttu-id="b9390-148">Если отображается ошибка "Данный проект ссылается на пакеты NuGet, отсутствующие на этом компьютере" или "Необходимо восстановить один или несколько пакетов NuGet, однако это невозможно без вашего согласия", [включите автоматическое восстановление](#enable-and-disable-package-restore-in-visual-studio).</span><span class="sxs-lookup"><span data-stu-id="b9390-148">If you see the error "This project references NuGet package(s) that are missing on this computer," or "One or more NuGet packages need to be restored but couldn't be because consent has not been granted," [enable automatic restore](#enable-and-disable-package-restore-in-visual-studio).</span></span> <span data-ttu-id="b9390-149">Для более старых проектов см. инструкции по [переходу на автоматическое восстановление пакетов](#migrate-to-automatic-package-restore-visual-studio).</span><span class="sxs-lookup"><span data-stu-id="b9390-149">For older projects, also see [Migrate to automatic package restore](#migrate-to-automatic-package-restore-visual-studio).</span></span> <span data-ttu-id="b9390-150">Дополнительные сведения см. в статье [Устранение ошибок при восстановлении пакетов](Package-restore-troubleshooting.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-150">Also see [Package Restore troubleshooting](Package-restore-troubleshooting.md).</span></span>

### <a name="restore-packages-manually-using-visual-studio"></a><span data-ttu-id="b9390-151">Восстановление пакетов вручную с помощью Visual Studio</span><span class="sxs-lookup"><span data-stu-id="b9390-151">Restore packages manually using Visual Studio</span></span>

1. <span data-ttu-id="b9390-152">Включите восстановление пакетов, выбрав **Средства** > **Параметры** > **Диспетчер пакетов NuGet**.</span><span class="sxs-lookup"><span data-stu-id="b9390-152">Enable package restore by choosing **Tools** > **Options** > **NuGet Package Manager**.</span></span> <span data-ttu-id="b9390-153">В разделе **Восстановление пакетов** щелкните **Разрешить NuGet скачивать отсутствующие пакеты**.</span><span class="sxs-lookup"><span data-stu-id="b9390-153">Under **Package Restore** options, select **Allow NuGet to download missing packages**.</span></span>

1. <span data-ttu-id="b9390-154">Щелкните правой кнопкой мыши решение в **обозревателе решений** и выберите **Восстановить пакеты NuGet**.</span><span class="sxs-lookup"><span data-stu-id="b9390-154">In **Solution Explorer**, right click the solution and select **Restore NuGet Packages**.</span></span>

   <span data-ttu-id="b9390-155">Если какие-либо пакеты по-прежнему установлены некорректно, в **обозревателе решений** отображается значок ошибки.</span><span class="sxs-lookup"><span data-stu-id="b9390-155">If one or more individual packages still aren't installed properly, **Solution Explorer** shows an error icon.</span></span> <span data-ttu-id="b9390-156">Щелкните правой кнопкой мыши и выберите **Управление пакетами NuGet**, а затем удалите и переустановите затронутые пакеты с помощью **диспетчера пакетов**.</span><span class="sxs-lookup"><span data-stu-id="b9390-156">Right-click and select **Manage NuGet Packages**, and then use **Package Manager** to uninstall and reinstall the affected packages.</span></span> <span data-ttu-id="b9390-157">Дополнительные сведения см. в статье [Переустановка и обновление пакетов](../consume-packages/reinstalling-and-updating-packages.md)</span><span class="sxs-lookup"><span data-stu-id="b9390-157">For more information, see [Reinstall and update packages](../consume-packages/reinstalling-and-updating-packages.md)</span></span>

   <span data-ttu-id="b9390-158">Если отображается ошибка "Данный проект ссылается на пакеты NuGet, отсутствующие на этом компьютере" или "Необходимо восстановить один или несколько пакетов NuGet, однако это невозможно без вашего согласия", [включите автоматическое восстановление](#enable-and-disable-package-restore-in-visual-studio).</span><span class="sxs-lookup"><span data-stu-id="b9390-158">If you see the error "This project references NuGet package(s) that are missing on this computer," or "One or more NuGet packages need to be restored but couldn't be because consent has not been granted," [enable automatic restore](#enable-and-disable-package-restore-in-visual-studio).</span></span> <span data-ttu-id="b9390-159">Для более старых проектов см. инструкции по [переходу на автоматическое восстановление пакетов](#migrate-to-automatic-package-restore-visual-studio).</span><span class="sxs-lookup"><span data-stu-id="b9390-159">For older projects, also see [Migrate to automatic package restore](#migrate-to-automatic-package-restore-visual-studio).</span></span> <span data-ttu-id="b9390-160">Дополнительные сведения см. в статье [Устранение ошибок при восстановлении пакетов](Package-restore-troubleshooting.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-160">Also see [Package Restore troubleshooting](Package-restore-troubleshooting.md).</span></span>

### <a name="enable-and-disable-package-restore-in-visual-studio"></a><span data-ttu-id="b9390-161">Включение и отключение восстановления пакетов с помощью Visual Studio</span><span class="sxs-lookup"><span data-stu-id="b9390-161">Enable and disable package restore in Visual Studio</span></span>

<span data-ttu-id="b9390-162">В Visual Studio для управления восстановлением пакетов используются преимущественно параметры в разделе **Средства** > **Параметры** > **Диспетчер пакетов NuGet**:</span><span class="sxs-lookup"><span data-stu-id="b9390-162">In Visual Studio, you control Package Restore primarily through **Tools** > **Options** > **NuGet Package Manager**:</span></span>

![Управление восстановлением пакетов с помощью параметров диспетчера пакетов NuGet](media/Restore-01-AutoRestoreOptions.png)

- <span data-ttu-id="b9390-164">Параметр **Разрешить NuGet скачивать отсутствующие пакеты** определяет все формы восстановления пакетов посредством изменения параметра `packageRestore/enabled` в [разделе packageRestore](../reference/nuget-config-file.md#packagerestore-section) файла `NuGet.Config` в каталоге `%AppData%\NuGet\` в Windows или `~/.nuget/NuGet/` в Mac/Linux.</span><span class="sxs-lookup"><span data-stu-id="b9390-164">**Allow NuGet to download missing packages** controls all forms of package restore by changing the `packageRestore/enabled` setting in the [packageRestore section](../reference/nuget-config-file.md#packagerestore-section) of the `NuGet.Config` file, at `%AppData%\NuGet\` on Windows, or `~/.nuget/NuGet/` on Mac/Linux.</span></span> <span data-ttu-id="b9390-165">Этот параметр также обеспечивает работу команды **Восстановить пакеты NuGet** в контекстном меню решения в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b9390-165">This setting also enables the **Restore NuGet Packages** command on the solution's context menu in Visual Studio, .</span></span>

    ```xml
    <configuration>
        <packageRestore>
            <!-- The 'enabled' key is True when the "Allow NuGet to download missing packages" checkbox is set.
                 Clearing the box sets this to False, disabling command-line, automatic, and MSBuild-integrated restore. -->
            <add key="enabled" value="True" />
        </packageRestore>
    </configuration>
    ```
    
  > [!Note]
  > <span data-ttu-id="b9390-166">Параметр `packageRestore/enabled` можно переопределить на глобальном уровне, задав для переменной среды с именем **EnableNuGetPackageRestore** значение True или False перед запуском Visual Studio или началом сборки.</span><span class="sxs-lookup"><span data-stu-id="b9390-166">To globally override the `packageRestore/enabled` setting, set the environment variable **EnableNuGetPackageRestore** with a value of True or False before launching Visual Studio or starting a build.</span></span>

- <span data-ttu-id="b9390-167">Параметр **Автоматически проверять отсутствие пакетов при сборке в Visual Studio** управляет автоматическим восстановлением путем изменения параметра `packageRestore/automatic` в [разделе packageRestore](../reference/nuget-config-file.md#packagerestore-section) файла `NuGet.Config`.</span><span class="sxs-lookup"><span data-stu-id="b9390-167">**Automatically check for missing packages during build in Visual Studio** controls automatic restore by changing the `packageRestore/automatic` setting in the [packageRestore section](../reference/nuget-config-file.md#packagerestore-section) of the `NuGet.Config` file.</span></span> <span data-ttu-id="b9390-168">Когда этот параметр имеет значение True, при запуске сборки из Visual Studio все отсутствующие пакеты восстанавливаются автоматически.</span><span class="sxs-lookup"><span data-stu-id="b9390-168">When this option is set to True, running a build from Visual Studio automatically restores any missing packages.</span></span> <span data-ttu-id="b9390-169">Этот параметр не влияет на сборки, выполняемые из командной строки MSBuild.</span><span class="sxs-lookup"><span data-stu-id="b9390-169">This setting doesn't affect builds run from the MSBuild command line.</span></span>

    ```xml
    ...
    <configuration>
        <packageRestore>
            <!-- The 'automatic' key is set to True when the "Automatically check for missing packages during
                 build in Visual Studio" checkbox is set. Clearing the box sets this to False and disables
                 automatic restore. -->
            <add key="automatic" value="True" />
        </packageRestore>
    </configuration>
    ```

<span data-ttu-id="b9390-170">Чтобы включить или отключить восстановление пакетов для всех пользователей на компьютере, разработчик или компания могут добавить параметры конфигурации в глобальный файл `nuget.config`.</span><span class="sxs-lookup"><span data-stu-id="b9390-170">To enable or disable Package Restore for all users on a computer, a developer or company can add the configuration settings to the global `nuget.config` file.</span></span> <span data-ttu-id="b9390-171">Глобальный файл `nuget.config` в Windows находится в каталоге `%ProgramData%\NuGet\Config` и иногда может размещаться в конкретной папке Visual Studio `\{IDE}\{Version}\{SKU}\`. В Mac/Linux его следует искать в каталоге `~/.local/share`.</span><span class="sxs-lookup"><span data-stu-id="b9390-171">The global `nuget.config` is in Windows at `%ProgramData%\NuGet\Config`, sometimes under a specific `\{IDE}\{Version}\{SKU}\` Visual Studio folder, or in Mac/Linux at `~/.local/share`.</span></span> <span data-ttu-id="b9390-172">После этого отдельные пользователи могут выборочно включить восстановление на уровне проекта по необходимости.</span><span class="sxs-lookup"><span data-stu-id="b9390-172">Individual users can then selectively enable restore as needed on a project level.</span></span> <span data-ttu-id="b9390-173">Дополнительные сведения о том, как NuGet устанавливает приоритеты для нескольких файлов конфигурации, см. в статье [Распространенные конфигурации NuGet](../consume-packages/configuring-nuget-behavior.md#how-settings-are-applied).</span><span class="sxs-lookup"><span data-stu-id="b9390-173">For more details on how NuGet prioritizes multiple config files, see [Common NuGet configurations](../consume-packages/configuring-nuget-behavior.md#how-settings-are-applied).</span></span>

> [!Important]
> <span data-ttu-id="b9390-174">При изменении параметров `packageRestore` прямо в `nuget.config` нужно перезапустить Visual Studio, чтобы диалоговое окно **Параметры** отображало текущие значения.</span><span class="sxs-lookup"><span data-stu-id="b9390-174">If you edit the `packageRestore` settings directly in `nuget.config`, restart Visual Studio, so that the **Options** dialog box shows the current values.</span></span>

### <a name="choose-default-package-management-format"></a><span data-ttu-id="b9390-175">Выбор формата управления пакетами по умолчанию</span><span class="sxs-lookup"><span data-stu-id="b9390-175">Choose default package management format</span></span>

![Настройка формата управления пакетами по умолчанию с помощью параметров диспетчера пакетов NuGet](media/Restore-02-PackageFormatOptions.png)

<span data-ttu-id="b9390-177">У NuGet есть два формата, в которых пакеты могут использоваться в проекте: [`PackageReference`](package-references-in-project-files.md) и [`packages.config`](../reference/packages-config.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-177">NuGet has two formats in which a project may use packages: [`PackageReference`](package-references-in-project-files.md) and [`packages.config`](../reference/packages-config.md).</span></span> <span data-ttu-id="b9390-178">Формат по умолчанию можно выбрать в раскрывающемся списке под заголовком **Управление пакетами**.</span><span class="sxs-lookup"><span data-stu-id="b9390-178">The default format can be selected from the drop-down under the **Package Management** heading.</span></span> <span data-ttu-id="b9390-179">Также доступен параметр, позволяющий выводить запрос при установке первого пакета в проекте.</span><span class="sxs-lookup"><span data-stu-id="b9390-179">An option to be prompted when the first package is installed in a project is also available.</span></span>

> [!Note]
> <span data-ttu-id="b9390-180">Если проект не поддерживает оба формата управления пакетами, используется формат, совместимый с данным проектом, поэтому он может отличаться от установленного по умолчанию в параметрах.</span><span class="sxs-lookup"><span data-stu-id="b9390-180">If a project does not support both package management formats, the package management format used will be the one that's compatible with the project, and therefore may not be the default set in the options.</span></span> <span data-ttu-id="b9390-181">Кроме того, NuGet не будет запрашивать выбор при установке первого пакета, даже если соответствующий параметр выбран в окне "Параметры".</span><span class="sxs-lookup"><span data-stu-id="b9390-181">Additionally, NuGet will not prompt for selection on first package installation, even if the option is selected in the options window.</span></span>
>
> <span data-ttu-id="b9390-182">Если консоль диспетчера пакетов используется для установки первого пакета в проекте, NuGet не будет запрашивать выбор формата, даже если соответствующий параметр выбран в окне "Параметры".</span><span class="sxs-lookup"><span data-stu-id="b9390-182">If Package Manager Console is used to install the first package in a project, NuGet will not prompt for format selection, even if the option is selected in the options window.</span></span>

## <a name="restore-using-the-dotnet-cli"></a><span data-ttu-id="b9390-183">Восстановление с помощью dotnet в CLI</span><span class="sxs-lookup"><span data-stu-id="b9390-183">Restore using the dotnet CLI</span></span>

[!INCLUDE [restore-dotnet-cli](includes/restore-dotnet-cli.md)]

> [!IMPORTANT]
> <span data-ttu-id="b9390-184">Чтобы добавить отсутствующую ссылку на пакет в файл проекта, используйте средство [dotnet add package](/dotnet/core/tools/dotnet-add-package?tabs=netcore2x), которое также выполняет команду `restore`.</span><span class="sxs-lookup"><span data-stu-id="b9390-184">To add a missing package reference to the project file, use [dotnet add package](/dotnet/core/tools/dotnet-add-package?tabs=netcore2x), which also runs the `restore` command.</span></span>

## <a name="restore-using-the-nugetexe-cli"></a><span data-ttu-id="b9390-185">Восстановление с помощью nuget.exe в CLI</span><span class="sxs-lookup"><span data-stu-id="b9390-185">Restore using the nuget.exe CLI</span></span>

[!INCLUDE [restore-nuget-exe-cli](includes/restore-nuget-exe-cli.md)]

> [!IMPORTANT]
> <span data-ttu-id="b9390-186">Команда `restore` не изменяет файл проекта или файл *packages.config*. Чтобы добавить зависимый компонент, добавьте пакет с помощью пользовательского интерфейса диспетчера пакетов или консоли в Visual Studio, либо измените файл *packages.config* и затем выполните команду `install` или `restore`.</span><span class="sxs-lookup"><span data-stu-id="b9390-186">The `restore`command does not modify a project file or *packages.config*. To add a dependency, either add a package through the Package Manager UI or Console in Visual Studio, or modify *packages.config* and then run either `install` or `restore`.</span></span>

## <a name="restore-using-msbuild"></a><span data-ttu-id="b9390-187">Восстановление с помощью MSBuild</span><span class="sxs-lookup"><span data-stu-id="b9390-187">Restore using MSBuild</span></span>

<span data-ttu-id="b9390-188">Чтобы восстановить пакеты, перечисленные в файле проекта, с помощью PackageReference, используйте команду [msbuild -t:restore](../reference/msbuild-targets.md#restore-target).</span><span class="sxs-lookup"><span data-stu-id="b9390-188">To restore packages listed in the project file with PackageReference, use the the [msbuild -t:restore](../reference/msbuild-targets.md#restore-target) command.</span></span> <span data-ttu-id="b9390-189">Эта команда доступна только в NuGet версии 4.x и более поздних и MSBuild версии 15.1 и более поздних, включенных в Visual Studio 2017 и более поздних версий.</span><span class="sxs-lookup"><span data-stu-id="b9390-189">This command is available only in NuGet 4.x+ and MSBuild 15.1+, which are included with Visual Studio 2017 and higher versions.</span></span> <span data-ttu-id="b9390-190">`nuget restore` и `dotnet restore` используют эту команду для подходящих проектов.</span><span class="sxs-lookup"><span data-stu-id="b9390-190">Both `nuget restore` and `dotnet restore` use this command for applicable projects.</span></span>

1. <span data-ttu-id="b9390-191">Откройте командную строку разработчика (в **поле поиска** введите **Командная строка разработчика**).</span><span class="sxs-lookup"><span data-stu-id="b9390-191">Open a Developer command prompt (In the **Search** box, type **Developer command prompt**).</span></span>

   <span data-ttu-id="b9390-192">В общем случае следует запустить Командную строку разработчика для Visual Studio из меню **Пуск**, так как в этом случае настраиваются все необходимые пути для MSBuild.</span><span class="sxs-lookup"><span data-stu-id="b9390-192">You typically want to start the Developer Command Prompt for Visual Studio from the **Start** menu, as it will be configured with all the necessary paths for MSBuild.</span></span>

2. <span data-ttu-id="b9390-193">Перейдите в папку, содержащую файл проекта, и введите следующую команду.</span><span class="sxs-lookup"><span data-stu-id="b9390-193">Switch to the folder containing the project file and type the following command.</span></span>

   ```cmd
   # Uses the project file in the current folder by default
   msbuild -t:restore
   ```

3. <span data-ttu-id="b9390-194">Введите следующую команду, чтобы перестроить проект.</span><span class="sxs-lookup"><span data-stu-id="b9390-194">Type the following command to rebuild the project.</span></span>

   ```cmd
   msbuild
   ```

   <span data-ttu-id="b9390-195">Убедитесь, что выходные данные MSBuild показывают, что сборка выполнена успешно.</span><span class="sxs-lookup"><span data-stu-id="b9390-195">Make sure that the MSBuild output indicates that the build completed successfully.</span></span>

## <a name="restore-using-azure-pipelines"></a><span data-ttu-id="b9390-196">Восстановление с помощью Azure Pipelines</span><span class="sxs-lookup"><span data-stu-id="b9390-196">Restore using Azure Pipelines</span></span>

<span data-ttu-id="b9390-197">При создании определения сборки в Azure Pipelines включите в него задачу восстановления [NuGet](/azure/devops/pipelines/tasks/package/nuget#restore-nuget-packages) или [.NET Core](/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=azure-devops), а затем добавьте задачу сборки.</span><span class="sxs-lookup"><span data-stu-id="b9390-197">When you create a build definition in Azure Pipelines, include the NuGet [restore](/azure/devops/pipelines/tasks/package/nuget#restore-nuget-packages) or .NET Core [restore](/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=azure-devops) task in the definition before any build tasks.</span></span> <span data-ttu-id="b9390-198">В некоторые шаблоны сборки задача восстановления включена по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="b9390-198">Some build templates include the restore task by default.</span></span>

## <a name="restore-using-azure-devops-server"></a><span data-ttu-id="b9390-199">Восстановление с помощью Azure DevOps Server</span><span class="sxs-lookup"><span data-stu-id="b9390-199">Restore using Azure DevOps Server</span></span>

<span data-ttu-id="b9390-200">В Azure DevOps Server и TFS 2013 и более поздних версий пакеты восстанавливаются автоматически во время сборки при условии, что вы используете шаблон командной сборки для TFS 2013 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="b9390-200">Azure DevOps Server and TFS 2013 and later automatically restore packages during build, if you're using a TFS 2013 or later Team Build template.</span></span> <span data-ttu-id="b9390-201">В более ранних версиях TFS вы можете включить в процесс сборки этап, на котором будет выполняться команда восстановления из командной строки, а также при необходимости перенести шаблон сборки в более позднюю версию.</span><span class="sxs-lookup"><span data-stu-id="b9390-201">For earlier TFS versions, you can include a build step to run a command-line restore option, or optionally migrate the build template to a later version.</span></span> <span data-ttu-id="b9390-202">Дополнительные сведения см. в статье [Настройка восстановления пакетов с помощью сборки Team Foundation](../consume-packages/team-foundation-build.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-202">For more information, see [Set up package restore with Team Foundation Build](../consume-packages/team-foundation-build.md).</span></span>

## <a name="constrain-package-versions-with-restore"></a><span data-ttu-id="b9390-203">Ограничение версий пакетов при восстановлении</span><span class="sxs-lookup"><span data-stu-id="b9390-203">Constrain package versions with restore</span></span>

<span data-ttu-id="b9390-204">Когда NuGet восстанавливает пакеты любым из методов, учитываются все ограничения, указанные в `packages.config` или файле проекта:</span><span class="sxs-lookup"><span data-stu-id="b9390-204">When NuGet restores packages through any method, it honors any constraints you specified in `packages.config` or the project file:</span></span>

- <span data-ttu-id="b9390-205">В файле `packages.config`, вы можете указать диапазон версий в свойстве `allowedVersion` зависимости.</span><span class="sxs-lookup"><span data-stu-id="b9390-205">In `packages.config`, you can specify a version range in the `allowedVersion` property of the dependency.</span></span> <span data-ttu-id="b9390-206">Дополнительные сведения см. в статье [Ограничение версий при обновлении](../consume-packages/reinstalling-and-updating-packages.md#constraining-upgrade-versions).</span><span class="sxs-lookup"><span data-stu-id="b9390-206">See [Constrain upgrade versions](../consume-packages/reinstalling-and-updating-packages.md#constraining-upgrade-versions) for more information.</span></span> <span data-ttu-id="b9390-207">Пример:</span><span class="sxs-lookup"><span data-stu-id="b9390-207">For example:</span></span>

    ```xml
    <package id="Newtonsoft.json" version="6.0.4" allowedVersions="[6,7)" />
    ```

- <span data-ttu-id="b9390-208">В файле проекта вы можете указать диапазон для зависимости напрямую, используя PackageReference.</span><span class="sxs-lookup"><span data-stu-id="b9390-208">In a project file, you can use PackageReference to specify a dependency's range directly.</span></span> <span data-ttu-id="b9390-209">Пример:</span><span class="sxs-lookup"><span data-stu-id="b9390-209">For example:</span></span>

    ```xml
    <PackageReference Include="Newtonsoft.json" Version="[6, 7)" />
    ```

<span data-ttu-id="b9390-210">Во всех случаях используйте нотацию, описанную в статье [Управление версиями пакета](../concepts/package-versioning.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-210">In all cases, use the notation described in [Package versioning](../concepts/package-versioning.md).</span></span>

## <a name="force-restore-from-package-sources"></a><span data-ttu-id="b9390-211">Принудительное восстановление из источников пакетов</span><span class="sxs-lookup"><span data-stu-id="b9390-211">Force restore from package sources</span></span>

<span data-ttu-id="b9390-212">По умолчанию в операциях восстановления NuGet используются пакеты из папки *global-packages* и *http-cache*, как описано в статье [Управление папкой установки глобальных пакетов, кэшем и временными папками](managing-the-global-packages-and-cache-folders.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-212">By default, NuGet restore operations use packages from the *global-packages* and *http-cache* folders, which are described in [Manage the global packages and cache folders](managing-the-global-packages-and-cache-folders.md).</span></span>

<span data-ttu-id="b9390-213">Чтобы папка *global-packages* не использовалась, сделайте следующее:</span><span class="sxs-lookup"><span data-stu-id="b9390-213">To avoid using the *global-packages* folder, do one of the following:</span></span>

- <span data-ttu-id="b9390-214">Очистите папку с помощью команды `nuget locals global-packages -clear` или `dotnet nuget locals global-packages --clear`.</span><span class="sxs-lookup"><span data-stu-id="b9390-214">Clear the folder using `nuget locals global-packages -clear` or `dotnet nuget locals global-packages --clear`.</span></span>
- <span data-ttu-id="b9390-215">Перед операцией восстановления временно измените расположение папки *global-packages* с помощью одного из следующих методов:</span><span class="sxs-lookup"><span data-stu-id="b9390-215">Temporarily change the location of the *global-packages* folder before the restore operation, using one of the following methods:</span></span>
  - <span data-ttu-id="b9390-216">В качестве значения переменной среды NUGET_PACKAGES задайте другую папку.</span><span class="sxs-lookup"><span data-stu-id="b9390-216">Set the NUGET_PACKAGES environment variable to a different folder.</span></span>
  - <span data-ttu-id="b9390-217">Создайте файл `NuGet.Config`, который в качестве значения параметра `globalPackagesFolder` (при использовании формата PackageReference) или `repositoryPath` (при использовании `packages.config`) задает другую папку.</span><span class="sxs-lookup"><span data-stu-id="b9390-217">Create a `NuGet.Config` file that sets `globalPackagesFolder` (if using PackageReference) or `repositoryPath` (if using `packages.config`) to a different folder.</span></span> <span data-ttu-id="b9390-218">Дополнительные сведения см. в статье, посвященной [параметрам конфигурации](../reference/nuget-config-file.md#config-section).</span><span class="sxs-lookup"><span data-stu-id="b9390-218">For more information, see [configuration settings](../reference/nuget-config-file.md#config-section).</span></span>
  - <span data-ttu-id="b9390-219">Только для MSBuild: Укажите другую папку с помощью свойства `RestorePackagesPath`.</span><span class="sxs-lookup"><span data-stu-id="b9390-219">MSBuild only: Specify a different folder with the `RestorePackagesPath` property.</span></span>

<span data-ttu-id="b9390-220">Чтобы не использовать кэш с источниками HTTP, выполните одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="b9390-220">To avoid using the cache for HTTP sources, do one of the following:</span></span>

- <span data-ttu-id="b9390-221">Используйте параметр `-NoCache` с `nuget restore` или параметр `--no-cache` с `dotnet restore`.</span><span class="sxs-lookup"><span data-stu-id="b9390-221">Use the `-NoCache` option with `nuget restore`, or the `--no-cache` option with `dotnet restore`.</span></span> <span data-ttu-id="b9390-222">Эти параметры не влияют на операции восстановления с помощью диспетчера пакетов или консоли Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b9390-222">These options don't affect restore operations through the Visual Studio Package Manager or console.</span></span>
- <span data-ttu-id="b9390-223">Очистите кэш с помощью команды `nuget locals http-cache -clear` или `dotnet nuget locals http-cache --clear`.</span><span class="sxs-lookup"><span data-stu-id="b9390-223">Clear the cache using `nuget locals http-cache -clear` or `dotnet nuget locals http-cache --clear`.</span></span>
- <span data-ttu-id="b9390-224">Временно в качестве значения переменной среды NUGET_HTTP_CACHE_PATH задайте другую папку.</span><span class="sxs-lookup"><span data-stu-id="b9390-224">Temporarily set the NUGET_HTTP_CACHE_PATH environment variable to a different folder.</span></span>

## <a name="migrate-to-automatic-package-restore-visual-studio"></a><span data-ttu-id="b9390-225">Переход на автоматическое восстановление пакетов (Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="b9390-225">Migrate to automatic package restore (Visual Studio)</span></span>

<span data-ttu-id="b9390-226">Диспетчер NuGet 2.6 и более ранних версий ранее поддерживал функцию восстановления пакетов, интегрированную в MSBuild. Но теперь такая функция недоступна</span><span class="sxs-lookup"><span data-stu-id="b9390-226">For NuGet 2.6 and earlier, an MSBuild-integrated package restore was previously supported but that is no longer true.</span></span> <span data-ttu-id="b9390-227">(обычно, чтобы включить ее, нужно было щелкнуть правой кнопки мыши решение в Visual Studio и выбрать **Enable NuGet Package Restore** (Включить восстановление пакетов NuGet)).</span><span class="sxs-lookup"><span data-stu-id="b9390-227">(It was typically enabled by right-clicking a solution in Visual Studio and selecting **Enable NuGet Package Restore**).</span></span> <span data-ttu-id="b9390-228">Если в проекте используется устаревшая функция восстановления пакетов, встроенная в MSBuild, перейдите на автоматическое восстановление пакетов.</span><span class="sxs-lookup"><span data-stu-id="b9390-228">If your project uses the deprecated MSBuild-integrated package restore, please migrate to automatic package restore.</span></span>

<span data-ttu-id="b9390-229">В проектах, где используется функция восстановления пакетов, встроенная в MSBuild, обычно есть папка *.nuget* с тремя файлами: *NuGet.config*, *nuget.exe* и *NuGet.targets*.</span><span class="sxs-lookup"><span data-stu-id="b9390-229">Projects that use MSBuild-Integrated package restore typically contain a *.nuget* folder with three files: *NuGet.config*, *nuget.exe*, and *NuGet.targets*.</span></span> <span data-ttu-id="b9390-230">Наличие файла *NuGet.targets* определяет, будет ли NuGet и дальше использовать встроенный в MSBuild метод. Поэтому этот файл необходимо удалить во время миграции.</span><span class="sxs-lookup"><span data-stu-id="b9390-230">The presence of a *NuGet.targets* file determines whether NuGet will continue to use the MSBuild-untegrated approach, so this file must be removed during the migration.</span></span>

<span data-ttu-id="b9390-231">Переход на автоматическое восстановление пакетов:</span><span class="sxs-lookup"><span data-stu-id="b9390-231">To migrate to automatic package restore:</span></span>

1. <span data-ttu-id="b9390-232">Закройте Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b9390-232">Close Visual Studio.</span></span>
2. <span data-ttu-id="b9390-233">Удалите *.nuget/nuget.exe* и *.nuget/NuGet.targets*.</span><span class="sxs-lookup"><span data-stu-id="b9390-233">Delete *.nuget/nuget.exe* and *.nuget/NuGet.targets*.</span></span>
3. <span data-ttu-id="b9390-234">Для каждого файла проекта удалите элемент `<RestorePackages>` и любые ссылки на *NuGet. targets*.</span><span class="sxs-lookup"><span data-stu-id="b9390-234">For each project file, remove the `<RestorePackages>` element and remove any reference to *NuGet.targets*.</span></span>

<span data-ttu-id="b9390-235">Тестирование автоматического восстановления пакетов:</span><span class="sxs-lookup"><span data-stu-id="b9390-235">To test the automatic package restore:</span></span>

1. <span data-ttu-id="b9390-236">Удалите папку из решения папку *packages*.</span><span class="sxs-lookup"><span data-stu-id="b9390-236">Remove the *packages* folder from the solution.</span></span>
2. <span data-ttu-id="b9390-237">Откройте решение в среде Visual Studio и начните сборку.</span><span class="sxs-lookup"><span data-stu-id="b9390-237">Open the solution in Visual Studio and start a build.</span></span>

   <span data-ttu-id="b9390-238">При автоматическом восстановлении пакетов должен скачиваться и устанавливаться каждый пакет зависимостей без добавления таких пакетов в систему управления версиями.</span><span class="sxs-lookup"><span data-stu-id="b9390-238">Automatic package restore should download and install each dependency package, without adding them to source control.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="b9390-239">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="b9390-239">Troubleshooting</span></span>

<span data-ttu-id="b9390-240">Дополнительные сведения см. в статье [Устранение ошибок при восстановлении пакетов](package-restore-troubleshooting.md).</span><span class="sxs-lookup"><span data-stu-id="b9390-240">See [Troubleshoot package restore](package-restore-troubleshooting.md).</span></span>
