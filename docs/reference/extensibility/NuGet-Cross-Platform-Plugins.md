---
title: Межплатформенные подключаемые модули NuGet
description: Межплатформенные подключаемые модули NuGet для NuGet. exe, DotNet. exe, MSBuild. exe и Visual Studio
author: nkolev92
ms.author: nikolev
ms.date: 07/01/2018
ms.topic: conceptual
ms.openlocfilehash: 00410214500c7f5256be243dd6fca0907ba9b0c4
ms.sourcegitcommit: 363ec6843409b4714c91b75b105619a3a3184b43
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72380501"
---
# <a name="nuget-cross-platform-plugins"></a>Межплатформенные подключаемые модули NuGet

Добавлена поддержка межплатформенных подключаемых модулей в NuGet 4.8 +.
Это достигается путем создания новой модели расширяемости подключаемого модуля, которая должна соответствовать определенному набору правил операции.
Подключаемые модули представляют собой самодостаточные исполняемые файлы (руннаблес в мире .NET Core), которые клиенты NuGet запускают в отдельном процессе.
Эта однократная запись выполняется один раз, запуская повсеместный подключаемый модуль. Он будет работать со всеми клиентскими средствами NuGet.
Подключаемые модули могут быть либо .NET Framework (NuGet. exe, MSBuild. exe и Visual Studio), либо .NET Core (DotNet. exe).
Определена версия протокола связи между клиентом NuGet и подключаемым модулем. Во время подтверждения запуска 2 процесса согласовывают версию протокола.

Чтобы охватить все сценарии клиентских средств NuGet, требуется как .NET Framework, так и подключаемый модуль .NET Core.
Ниже описаны сочетания подключаемых модулей для клиента и платформы.

| Клиентская программа  | Платформа |
| ------------ | --------- |
| Visual Studio | .NET Framework |
| dotnet.exe | .NET Core |
| NuGet. exe | .NET Framework |
| MSBuild. exe | .NET Framework |
| NuGet. exe на Mono | .NET Framework |

## <a name="how-does-it-work"></a>Как это работает

Рабочий процесс высокого уровня можно описать следующим образом:

1. NuGet обнаруживает доступные подключаемые модули.
1. Если это применимо, NuGet перебирает подключаемые модули в порядке приоритета и запускает их по одному.
1. NuGet будет использовать первый подключаемый модуль, который может обслуживать запрос.
1. Подключаемые модули будут закрыты, когда они больше не нужны.

## <a name="general-plugin-requirements"></a>Общие требования к подключаемому модулю

Текущая версия протокола — *2.0.0*.
Ниже приведены требования к этой версии.

- Иметь действительные доверенные сборки Authenticode-подписи, которые будут выполняться в Windows и Mono. Никаких специальных требований к доверию для сборок, работающих в Linux и Mac, пока нет. [Соответствующая ошибка](https://github.com/NuGet/Home/issues/6702)
- Поддержка запуска без отслеживания состояния в текущем контексте безопасности клиентских средств NuGet. Например, клиентские средства NuGet не будут выполнять повышение или дополнительную инициализацию за пределами протокола подключаемого модуля, описанного ниже.
- Быть не интерактивным, если явно не указано иное.
- Придерживайтесь к согласованной версии протокола подключаемого модуля.
- Отвечать на все запросы в течение разумного периода времени.
- Соблюдайте запросы на отмену для любой выполняющейся операции.

Техническая спецификация подробно описана в следующих спецификациях:

- [Подключаемый модуль скачивания пакетов NuGet](https://github.com/NuGet/Home/wiki/NuGet-Package-Download-Plugin)
- [Подключаемый модуль Plat проверки подлинности NuGet](https://github.com/NuGet/Home/wiki/NuGet-cross-plat-authentication-plugin)

## <a name="client---plugin-interaction"></a>Взаимодействие с подключаемым модулем клиента

Клиентские средства NuGet и подключаемые модули взаимодействуют с JSON через стандартные потоки (stdin, stdout, stderr). Все данные должны быть закодированы в кодировке UTF-8.
Подключаемые модули запускаются с аргументом "-plugin". Если пользователь непосредственно запускает исполняемый файл подключаемого модуля без этого аргумента, подключаемый модуль может предоставить информативное сообщение вместо того, чтобы ждать подтверждения протокола.
Время ожидания подтверждения протокола — 5 секунд. Подключаемый модуль должен завершить установку в как можно меньшее количество.
Клиентские средства NuGet запрашивают поддерживаемые операции подключаемого модуля, передавая индекс службы для источника NuGet. Подключаемый модуль может использовать индекс службы для проверки наличия поддерживаемых типов служб.

Обмен данными между клиентскими инструментами NuGet и подключаемым модулем осуществляется по двунаправленному соединению. Время ожидания каждого запроса составляет 5 секунд. Если операции должны занимать больше времени, необходимо отправить сообщение о ходе выполнения, чтобы предотвратить истечение тайм-аута запроса. После 1 минуты бездействия подключаемый модуль считается бездействующим и завершает работу.

## <a name="plugin-installation-and-discovery"></a>Установка и обнаружение подключаемого модуля

Подключаемые модули будут обнаружены с помощью структуры каталогов на основе соглашений.
Сценарии CI/CD и опытные пользователи могут использовать переменные среды для переопределения поведения. При использовании переменных среды разрешены только абсолютные пути. Обратите внимание, что `NUGET_NETFX_PLUGIN_PATHS` и `NUGET_NETCORE_PLUGIN_PATHS` доступны только в версии 5.3 + средства NuGet и более поздних версий.

- `NUGET_NETFX_PLUGIN_PATHS` — определяет подключаемые модули, которые будут использоваться средствами на основе .NET Framework (NuGet. exe/MSBuild. exe/Visual Studio). Имеет приоритет над `NUGET_PLUGIN_PATHS`. (Только NuGet версии 5.3 +)
- `NUGET_NETCORE_PLUGIN_PATHS` — определяет подключаемые модули, которые будут использоваться инструментами на основе .NET Core (DotNet. exe). Имеет приоритет над `NUGET_PLUGIN_PATHS`. (Только NuGet версии 5.3 +)
- `NUGET_PLUGIN_PATHS` — определяет подключаемые модули, которые будут использоваться для этого процесса NuGet, с сохранением приоритета. Если эта переменная среды задана, она переопределяет обнаружение на основе соглашения. Игнорируется, если указана любая из переменных, определенных для платформы.
-  Расположение пользователя, корневое расположение NuGet в `%UserProfile%/.nuget/plugins`. Это расположение нельзя переопределить. Для подключаемых модулей .NET Core и .NET Framework будет использоваться другой корневой каталог.

| Платформа | Расположение корневого обнаружения  |
| ------- | ------------------------ |
| .NET Core |  `%UserProfile%/.nuget/plugins/netcore` |
| .NET Framework | `%UserProfile%/.nuget/plugins/netfx` |

Каждый подключаемый модуль должен быть установлен в отдельную папку.
Точкой входа подключаемого модуля будет имя установленной папки с расширениями DLL для .NET Core и расширением exe для .NET Framework.

```
.nuget
    plugins
        netfx
            myPlugin
                myPlugin.exe
                nuget.protocol.dll
                ...
        netcore
            myPlugin
                myPlugin.dll
                nuget.protocol.dll
                ...
```

> [!Note]
> В настоящее время нет пользовательской истории для установки подключаемых модулей. Это так же просто, как перемещение необходимых файлов в предварительно определенное расположение.

## <a name="supported-operations"></a>Поддерживаемые операции

В новом протоколе подключаемого модуля поддерживаются две операции.

| Имя операции | Минимальная версия протокола | Минимальная версия клиента NuGet |
| -------------- | ----------------------- | --------------------- |
| Скачать пакет | 1.0.0 | 4.3.0 |
| [Authentication](NuGet-Cross-Platform-Authentication-Plugin.md) | 2.0.0 | 4.8.0 |

## <a name="running-plugins-under-the-correct-runtime"></a>Запуск подключаемых модулей в правильной среде выполнения

Для NuGet в сценариях DotNet. exe подключаемые модули должны иметь возможность выполнения в этой конкретной среде выполнения файла DotNet. exe.
Он находится в поставщике подключаемого модуля и потребителе, чтобы убедиться в том, что используется совместимое сочетание DotNet. exe/plugin.
При использовании подключаемых модулей пользовательского расположения может возникнуть потенциальная ошибка. Например, DotNet. exe в среде выполнения 2,0 пытается использовать подключаемый модуль, написанный для среды выполнения 2,1.

## <a name="capabilities-caching"></a>Кэширование возможностей

Проверка безопасности и создание экземпляров подключаемых модулей являются дорогостоящими. Операция загрузки выполняется чаще, чем операция проверки подлинности, однако средний пользователь NuGet, скорее всего, будет иметь подключаемый модуль проверки подлинности.
Чтобы улучшить работу, NuGet кэширует утверждения операций для данного запроса. Этот кэш предназначен для каждого подключаемого модуля с ключом подключаемого модуля, который является путем к подключаемому модулю, а срок действия этого кэша возможностей составляет 30 дней. 

Кэш находится в `%LocalAppData%/NuGet/plugins-cache` и должен быть переопределен переменной среды `NUGET_PLUGINS_CACHE_PATH`. Чтобы очистить этот [кэш](../../consume-packages/managing-the-global-packages-and-cache-folders.md), можно выполнить команду Locals с параметром `plugins-cache`.
Параметр локальных переменных `all` теперь также будет удалять кэш подключаемых модулей. 

## <a name="protocol-messages-index"></a>Индекс сообщений протокола

Сообщения версии протокола *1.0.0* :

1.  Закрыть
    * Направление запроса: подключаемый модуль NuGet->
    * Запрос не будет содержать полезных данных
    * Ответ не ожидается.  Правильный ответ заключается в том, что процесс подключаемого модуля будет быстро выходить из него.

2.  Копировать файлы в пакет
    * Направление запроса: подключаемый модуль NuGet->
    * Запрос будет содержать:
        * ИДЕНТИФИКАТОР и версия пакета
        * расположение исходного репозитория пакета
        * путь к каталогу назначения
        * перечислимые файлы в пакете, которые будут скопированы в путь к каталогу назначения
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * перечислимые полные пути для скопированных файлов в целевом каталоге, если операция выполнена успешно

3.  Копировать файл пакета (. nupkg)
    * Направление запроса: подключаемый модуль NuGet->
    * Запрос будет содержать:
        * ИДЕНТИФИКАТОР и версия пакета
        * расположение исходного репозитория пакета
        * путь к целевому файлу
    * Ответ будет содержать:
        * код ответа, указывающий результат операции

4.  Получение учетных данных
    * Направление запроса: подключаемый модуль — > NuGet.
    * Запрос будет содержать:
        * расположение исходного репозитория пакета
        * код состояния HTTP, полученный из исходного репозитория пакета с использованием текущих учетных данных
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * имя пользователя, если оно доступно
        * пароль, если он доступен

5.  Получение файлов в пакете
    * Направление запроса: подключаемый модуль NuGet->
    * Запрос будет содержать:
        * ИДЕНТИФИКАТОР и версия пакета
        * расположение исходного репозитория пакета
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * перечислимые пути к файлам в пакете, если операция выполнена успешно

6.  Получение утверждений операции 
    * Направление запроса: подключаемый модуль NuGet->
    * Запрос будет содержать:
        * Service index. JSON для источника пакета
        * расположение исходного репозитория пакета
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * перечислимые поддерживаемые операции (например, скачивание пакета), если операция выполнена успешно.  Если подключаемый модуль не поддерживает источник пакета, подключаемый модуль должен вернуть пустой набор поддерживаемых операций.

> [!Note]
> Это сообщение было Обновлено в версии *2.0.0*. Она находится на клиенте для сохранения обратной совместимости.

7.  Получить хэш пакета
    * Направление запроса: подключаемый модуль NuGet->
    * Запрос будет содержать:
        * ИДЕНТИФИКАТОР и версия пакета
        * расположение исходного репозитория пакета
        * хэш-алгоритм
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * хэш файла пакета с использованием запрошенного хэш-алгоритма, если операция выполнена успешно

8.  Получение версий пакета
    * Направление запроса: подключаемый модуль NuGet->
    * Запрос будет содержать:
        * Идентификатор пакета
        * расположение исходного репозитория пакета
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * перечислимые версии пакета, если операция выполнена успешно

9.  Получение индекса службы
    * Направление запроса: подключаемый модуль — > NuGet.
    * Запрос будет содержать:
        * расположение исходного репозитория пакета
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * индекс службы, если операция выполнена успешно

10.  Подтверждения
     * Направление запроса: подключаемый модуль > NuGet <
     * Запрос будет содержать:
         * Текущая версия протокола подключаемого модуля
         * Минимальная поддерживаемая версия протокола подключаемого модуля
     * Ответ будет содержать:
         * код ответа, указывающий результат операции
         * согласованная версия протокола, если операция выполнена успешно.  Сбой приведет к завершению работы подключаемого модуля.

11.  Initialize
     * Направление запроса: подключаемый модуль NuGet->
     * Запрос будет содержать:
         * версия клиентского средства NuGet
         * эффективный язык клиентского средства NuGet.  При этом учитывается параметр Форцеенглишаутпут, если он используется.
         * время ожидания запроса по умолчанию, заменяющее протокол по умолчанию.
     * Ответ будет содержать:
         * код ответа, указывающий результат операции.  Сбой приведет к завершению работы подключаемого модуля.

12.  Журнал
     * Направление запроса: подключаемый модуль — > NuGet.
     * Запрос будет содержать:
         * уровень ведения журнала для запроса
         * сообщение для записи
     * Ответ будет содержать:
         * код ответа, указывающий результат операции.

13.  Мониторинг завершения процесса NuGet
     * Направление запроса: подключаемый модуль NuGet->
     * Запрос будет содержать:
         * Идентификатор процесса NuGet
     * Ответ будет содержать:
         * код ответа, указывающий результат операции.

14.  Предзагрузка пакета
     * Направление запроса: подключаемый модуль NuGet->
     * Запрос будет содержать:
         * ИДЕНТИФИКАТОР и версия пакета
         * расположение исходного репозитория пакета
     * Ответ будет содержать:
         * код ответа, указывающий результат операции

15.  Настройка учетных данных
     * Направление запроса: подключаемый модуль NuGet->
     * Запрос будет содержать:
         * расположение исходного репозитория пакета
         * Последнее известное имя пользователя источника пакета, если оно доступно
         * Последний известный пароль источника пакета, если он доступен
         * Последнее известное имя пользователя-посредника, если оно доступно
         * Последний известный пароль прокси-сервера, если он доступен
     * Ответ будет содержать:
         * код ответа, указывающий результат операции

16.  Задать уровень ведения журнала
     * Направление запроса: подключаемый модуль NuGet->
     * Запрос будет содержать:
         * уровень журнала по умолчанию
     * Ответ будет содержать:
         * код ответа, указывающий результат операции

Сообщения версии протокола *2.0.0*

17. Получение утверждений операции

* Направление запроса: подключаемый модуль NuGet->
    * Запрос будет содержать:
        * Service index. JSON для источника пакета
        * расположение исходного репозитория пакета
    * Ответ будет содержать:
        * код ответа, указывающий результат операции
        * перечислимые поддерживаемые операции, если операция выполнена успешно.  Если подключаемый модуль не поддерживает источник пакета, подключаемый модуль должен вернуть пустой набор поддерживаемых операций.

    Если индекс службы и источник пакета имеют значение null, то подключаемый модуль может ответить с проверкой подлинности.

18. Получение учетных данных проверки подлинности

* Направление запроса: подключаемый модуль NuGet->
* Запрос будет содержать:
    * URI
    * Повтор
    * Неинтерактивная
    * каншовдиалог
* Ответ будет содержать
    * Имя пользователя
    * Пароль
    * Сообщение
    * Список типов проверки подлинности
    * мессажереспонсекоде
